{% extends "base.html" %}

{% block content %}
<h1>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</h1>

<div class="progress-bar-container">
    <div id="progress-bar" class="progress-bar">
        0%
    </div>
</div>

<p>–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏: <strong>{{ uid }}</strong></p>
<p>–ò–º—è —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: <strong id="filename">...</strong></p>
<p id="status-message"><strong>–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∏...</strong></p>

<button class="redButton" id="nextButton"
        style="width: 100%; margin-top: 10px"
        onclick="window.location.href='/files'">–ù–∞ –≥–ª–∞–≤–Ω—É—é üßº</button>

<button class="floating-button" id="logoutButton">–ù–∞ –≤—ã—Ö–æ–¥! üö™</button>



<script>
    const progressBar = document.getElementById("progress-bar");
    const statusMessage = document.getElementById("status-message");
    const filenameMessage = document.getElementById("filename");
    const uid = "{{ uid }}"; // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä–æ–º
    const WS_TIMEOUT = 10000; // –í—Ä–µ–º—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö

    const ws = new WebSocket(`ws://localhost:7999/ws/${uid}`);
    let timeoutId;

    function showAlert(message) {
	    const modal = document.createElement('div');
	    modal.className = 'modal-overlay';

	    const dialog = document.createElement('div');
	    dialog.className = 'modal-dialog';
	    dialog.innerHTML = `
            <p>${message}</p>
            <button id="closeWebSocket" class="modal-button">–ó–∞–∫—Ä—ã—Ç—å WebSocket</button>
            <button id="closeAndRedirect" class="modal-button">–ó–∞–∫—Ä—ã—Ç—å WebSocket –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–≥—Ä—É–∑–∫—É</button>
        `;

	    modal.appendChild(dialog);
	    document.body.appendChild(modal);

	    document.getElementById('closeWebSocket').addEventListener('click', () => {
		    ws.close();
		    modal.remove();
	    });

	    document.getElementById('closeAndRedirect').addEventListener('click', () => {
		    ws.close();
		    modal.remove();
		    window.location.href = "/last_upload";
	    });
    }

    function startTimeout() {
	    clearTimeout(timeoutId);
	    timeoutId = setTimeout(() => {
		    showAlert("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ö–∞–∫ –ø–æ—Å—Ç—É–ø–∏–º? ü§î");
	    }, WS_TIMEOUT);
    }

    ws.onmessage = function (event) {
	    const data = JSON.parse(event.data);

	    // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
	    startTimeout();

	    const progress = (data.uploaded / data.total) * 100;

	    progressBar.style.width = progress + "%";
	    progressBar.innerText = Math.floor(progress) + "%";

	    statusMessage.innerText = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.uploaded} –∏–∑ ${data.total} –±–∞–π—Ç`;
	    filenameMessage.innerText = data.filename;

	    if (progress >= 100) {
		    ws.close();
		    statusMessage.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!";
	    }
    };

    ws.onopen = function () {
	    startTimeout();
    };

    ws.onclose = function () {
	    console.log("WebSocket –∑–∞–∫—Ä—ã—Ç.");
	    clearTimeout(timeoutId);
    };

    ws.onerror = function (error) {
	    console.error("–û—à–∏–±–∫–∞ WebSocket:", error);
	    statusMessage.innerText = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.";
	    clearTimeout(timeoutId);
    };

    document.getElementById('logoutButton').addEventListener('click', function () {
	    document.cookie.split(';').forEach(function (c) {
		    document.cookie = c.trim().split('=')[0] + '=;expires=' + new Date(0).toUTCString() + ';path=/';
	    });
	    window.location.href = "/login";
    });
</script>
{% endblock %}
